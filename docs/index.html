<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PA Airport Status</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body { font-family: system-ui,Segoe UI,Roboto,Arial,sans-serif; margin:16px; }
h1 { font-size:1.3rem; margin:0 0 6px 0; }

#map { height:320px; border:1px solid #333; border-radius:12px; }

.grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(420px,1fr)); gap:12px; }

.card { border:1px solid #333; border-radius:12px; padding:10px; }
.card h2 { margin:0 0 8px 0; font-size:1.1rem; }

table { width:100%; border-collapse:collapse; }
th,td { padding:6px; border-top:1px solid #ddd; text-align:left; }

.pill { padding:3px 10px; border-radius:999px; border:1px solid #333; font-weight:800; font-size:.85rem; }
.ok { background:#d4edda; }
.impact { background:#fff3cd; }
.closed { background:#f8d7da; }

#satCtl { margin-top:8px; display:flex; gap:12px; align-items:center; }
</style>
</head>

<body>

<h1>PA Airport Status</h1>
<div id="meta">Loadingâ€¦</div>

<div id="map"></div>

<div id="satCtl">
  <label><input type="checkbox" id="satToggle"> Satellite</label>
  <label>Opacity</label>
  <input type="range" id="satOpacity" min="0" max="100" value="55">
  <span id="satPct">55%</span>
</div>

<br>

<div class="grid" id="grid"></div>

<script>
let map = L.map("map").setView([40.9,-77.7],7);

let base = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

let sat = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  {maxZoom:19,opacity:0.55}
);

let markers = L.layerGroup().addTo(map);

document.getElementById("satToggle").onchange = e=>{
  e.target.checked ? sat.addTo(map) : map.removeLayer(sat);
};
document.getElementById("satOpacity").oninput = e=>{
  let v=e.target.value;
  document.getElementById("satPct").textContent=v+"%";
  sat.setOpacity(v/100);
};

async function load(){
  const r = await fetch("status.json?"+Date.now());
  const d = await r.json();

  document.getElementById("meta").textContent =
    "Last update: "+d.generated_utc+" UTC";

  markers.clearLayers();
  let grid="";

  for(const [region,aps] of Object.entries(d.regions)){
    let rows="";
    for(const a of aps){
      const st=d.airports[a.code];
      let cls="ok";
      if(st.status==="IMPACT") cls="impact";
      if(st.status==="CLOSED") cls="closed";

      rows+=`<tr>
        <td><b>${a.code}</b><br>${a.name}</td>
        <td><span class="pill ${cls}">${st.status}</span></td>
        <td>${st.flight_category||""}</td>
      </tr>`;

      let col = st.status==="CLOSED"?"red":st.status==="IMPACT"?"orange":"green";

      L.circleMarker([a.lat,a.lon],{
        radius:7,weight:2,color:"#000",fillColor:col,fillOpacity:0.8
      }).bindPopup(`<b>${a.code}</b><br>${a.name}<br>Status: ${st.status}<br>Flight: ${st.flight_category}`)
      .addTo(markers);
    }

    grid+=`
    <div class="card">
      <h2>${region}</h2>
      <table>
        <tr><th>Airport</th><th>Status</th><th>Flight</th></tr>
        ${rows}
      </table>
    </div>`;
  }

  document.getElementById("grid").innerHTML = grid;
}

load();
setInterval(load,300000);
</script>

</body>
</html>
