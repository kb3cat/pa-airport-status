<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PA Airport Status</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; color:#111; }
    header { display:flex; flex-wrap:wrap; align-items:baseline; gap: 10px; margin-bottom: 10px; }
    h1 { font-size: 1.25rem; margin: 0; }
    .meta { font-size: 0.9rem; color:#333; }
    .btn { padding: 6px 10px; border-radius: 10px; border:1px solid #333; background:#fff; cursor:pointer; }

    /* OVERALL STATUS BAR */
    .overall {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin: 10px 0 10px 0;
      padding: 10px 12px;
      border: 1px solid #333;
      border-radius: 12px;
      flex-wrap: wrap;
    }
    .overall-left { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .overall-dot { width: 12px; height: 12px; border-radius: 999px; border:1px solid #333; display:inline-block; }
    .overall-title { font-weight: 900; }
    .overall-text { font-weight: 900; }
    .overall-counts { font-size: 0.95rem; color:#222; font-variant-numeric: tabular-nums; }
    .overall-ok { background:#d4edda; }
    .overall-impact { background:#fff3cd; }
    .overall-closed { background:#f8d7da; }
    .dot-ok { background:#2ecc71; }
    .dot-impact { background:#f1c40f; }
    .dot-closed { background:#e74c3c; }

    #map { height: 360px; border: 1px solid #333; border-radius: 12px; overflow:hidden; background:#fafafa; }

    .legend { display:flex; gap: 12px; align-items:center; margin-top: 8px; font-size: 0.9rem; color:#222; flex-wrap:wrap; }
    .dot { width: 10px; height: 10px; border-radius: 999px; display:inline-block; border:1px solid #333; }
    .dot-ok { background:#2ecc71; }
    .dot-impact { background:#f1c40f; }
    .dot-closed { background:#e74c3c; }

    /* Toggle switches */
    .toggles {
      margin-top: 8px;
      display:flex;
      flex-wrap: wrap;
      gap: 14px 18px;
      align-items: center;
      font-size: 0.95rem;
    }
    .toggle {
      display:flex;
      align-items:center;
      gap:10px;
      border:1px solid #333;
      border-radius: 12px;
      padding: 8px 10px;
      background:#fff;
    }
    .toggle .label { font-weight: 800; }
    .switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
      flex: 0 0 auto;
    }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #ddd;
      border: 1px solid #333;
      transition: .15s;
      border-radius: 999px;
    }
    .slider:before {
      position: absolute; content: "";
      height: 18px; width: 18px;
      left: 3px; top: 2px;
      background: #fff;
      border: 1px solid #333;
      transition: .15s;
      border-radius: 999px;
    }
    .switch input:checked + .slider { background: #d4edda; }
    .switch input:checked + .slider:before { transform: translateX(19px); }

    /* Overlay opacity control */
    .opacityCtl {
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 8px;
      font-size: 0.95rem;
    }
    .opacityCtl label { font-weight: 800; }
    #overlayOpacity { width: 240px; }
    #overlayPct { font-variant-numeric: tabular-nums; font-weight: 900; }

    /* Flight Rules Key (only shown when toggle on) */
    #frKey {
      display: none;
      margin-top: 8px;
      border: 1px solid #333;
      border-radius: 12px;
      padding: 8px 10px;
      background: #fff;
      font-size: 0.95rem;
      align-items: center;
      gap: 14px;
      flex-wrap: wrap;
    }
    #frKey .title { font-weight: 900; margin-right: 6px; }
    .keyItem { display:flex; align-items:center; gap:8px; }
    .keyDot { width: 12px; height: 12px; border-radius: 999px; border:1px solid #333; display:inline-block; }
    .k-vfr { background:#2ecc71; }
    .k-mvfr { background:#f1c40f; }
    .k-ifr { background:#e74c3c; }
    .k-lifr { background:#9b59b6; }
    .k-unk { background:#95a5a6; }

    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(440px, 1fr)); gap: 12px; margin-top: 12px; }
    .card { border:1px solid #333; border-radius: 12px; padding: 10px; }
    .card h2 { margin: 0 0 8px 0; font-size: 1.05rem; }

    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; vertical-align: top; padding: 6px; border-top: 1px solid #ddd; }
    th { font-weight: 800; }

    .pill {
      display:inline-block;
      padding: 2px 10px;
      border-radius: 999px;
      border:1px solid #333;
      font-size: 0.85rem;
      font-weight: 900;
      line-height: 1.4;
      white-space: nowrap;
    }
    .pill-ok { background: #d4edda; }
    .pill-impact { background: #fff3cd; }
    .pill-closed { background: #f8d7da; }

    .pill-vfr { background:#d4edda; }
    .pill-mvfr { background:#fff3cd; }
    .pill-ifr { background:#f8d7da; }
    .pill-lifr { background:#e6d6ff; }
    .pill-unk { background:#eee; }

    .muted { color:#666; }
    .small { font-size: 0.9rem; color:#444; }
  </style>
</head>

<body>
<header>
  <h1>PA Airport Status</h1>
  <button class="btn" id="refreshBtn">Refresh</button>
  <div class="meta" id="meta">Loadingâ€¦</div>
</header>

<!-- OVERALL STATUS BAR -->
<div id="overallBar" class="overall overall-ok" role="status" aria-live="polite">
  <div class="overall-left">
    <span id="overallDot" class="overall-dot dot-ok" aria-hidden="true"></span>
    <span class="overall-title">Overall:</span>
    <span id="overallText" class="overall-text">OK</span>
  </div>
  <div id="overallCounts" class="overall-counts"></div>
</div>

<div id="map"></div>

<div class="legend">
  <span><span class="dot dot-closed"></span> CLOSED</span>
  <span><span class="dot dot-impact"></span> IMPACT</span>
  <span><span class="dot dot-ok"></span> OK</span>
</div>

<!-- Toggles -->
<div class="toggles">
  <div class="toggle">
    <span class="label">Cloud overlay</span>
    <label class="switch" title="Toggle cloud satellite overlay">
      <input type="checkbox" id="cloudToggle">
      <span class="slider"></span>
    </label>
  </div>

  <div class="toggle">
    <span class="label">Radar overlay</span>
    <label class="switch" title="Toggle radar overlay">
      <input type="checkbox" id="radarToggle">
      <span class="slider"></span>
    </label>
  </div>

  <div class="toggle">
    <span class="label">Flight rules colors</span>
    <label class="switch" title="Color dots by flight rules (no map labels)">
      <input type="checkbox" id="flightRulesToggle">
      <span class="slider"></span>
    </label>
  </div>
</div>

<!-- Flight rules key: appears only when flight rules toggle is ON -->
<div id="frKey">
  <span class="title">Flight Rules Key:</span>
  <span class="keyItem"><span class="keyDot k-vfr"></span> VFR</span>
  <span class="keyItem"><span class="keyDot k-mvfr"></span> MVFR</span>
  <span class="keyItem"><span class="keyDot k-ifr"></span> IFR</span>
  <span class="keyItem"><span class="keyDot k-lifr"></span> LIFR</span>
  <span class="keyItem"><span class="keyDot k-unk"></span> UNK</span>
</div>

<div class="opacityCtl">
  <label for="overlayOpacity">Overlay opacity</label>
  <input id="overlayOpacity" type="range" min="0" max="100" value="55" />
  <span id="overlayPct">55%</span>
</div>

<div class="grid" id="grid"></div>

<script>
const REFRESH_MS = 5 * 60 * 1000;

function esc(s){
  return (s ?? "").toString().replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}

function statusPill(status){
  const s = (status || "OK").toUpperCase();
  if (s === "CLOSED") return '<span class="pill pill-closed">CLOSED</span>';
  if (s === "IMPACT") return '<span class="pill pill-impact">IMPACT</span>';
  return '<span class="pill pill-ok">OK</span>';
}

function flightPill(cat){
  const c = (cat || "UNK").toUpperCase();
  if (c === "VFR") return '<span class="pill pill-vfr">VFR</span>';
  if (c === "MVFR") return '<span class="pill pill-mvfr">MVFR</span>';
  if (c === "IFR") return '<span class="pill pill-ifr">IFR</span>';
  if (c === "LIFR") return '<span class="pill pill-lifr">LIFR</span>';
  return '<span class="pill pill-unk">UNK</span>';
}

function markerColor(status){
  const s = (status || "OK").toUpperCase();
  if (s === "CLOSED") return "#e74c3c";
  if (s === "IMPACT") return "#f1c40f";
  return "#2ecc71";
}

function flightRuleColor(cat){
  const c = (cat || "UNK").toUpperCase();
  if (c === "VFR") return "#2ecc71";
  if (c === "MVFR") return "#f1c40f";
  if (c === "IFR") return "#e74c3c";
  if (c === "LIFR") return "#9b59b6";
  return "#95a5a6";
}

/* OVERALL BAR UPDATE */
function updateOverallBar(airportsObj){
  const bar = document.getElementById("overallBar");
  const dot = document.getElementById("overallDot");
  const text = document.getElementById("overallText");
  const countsEl = document.getElementById("overallCounts");

  let ok = 0, impact = 0, closed = 0, unknown = 0, total = 0;

  for (const code of Object.keys(airportsObj || {})) {
    total++;
    const st = ((airportsObj[code] || {}).status || "OK").toUpperCase();
    if (st === "CLOSED") closed++;
    else if (st === "IMPACT") impact++;
    else if (st === "OK") ok++;
    else unknown++;
  }

  let overall = "OK";
  if (closed > 0) overall = "CLOSED";
  else if (impact > 0) overall = "IMPACT";

  bar.classList.remove("overall-ok","overall-impact","overall-closed");
  dot.classList.remove("dot-ok","dot-impact","dot-closed");

  if (overall === "CLOSED") { bar.classList.add("overall-closed"); dot.classList.add("dot-closed"); }
  else if (overall === "IMPACT") { bar.classList.add("overall-impact"); dot.classList.add("dot-impact"); }
  else { bar.classList.add("overall-ok"); dot.classList.add("dot-ok"); }

  text.textContent = overall;

  const parts = [
    `Closed: ${closed}`,
    `Impact: ${impact}`,
    `OK: ${ok}`,
    (unknown ? `Unknown: ${unknown}` : null),
    `Total: ${total}`
  ].filter(Boolean);

  countsEl.textContent = parts.join("  |  ");
}

// -----------------------------
// Map setup
// -----------------------------
const map = L.map("map").setView([40.9, -77.7], 7);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19,
  attribution: "&copy; OpenStreetMap"
}).addTo(map);

// Overlays
const clouds = L.tileLayer(
  "https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/sat/{z}/{x}/{y}.png",
  { maxZoom: 8, opacity: 0.55, attribution: "NOAA GOES-East (IEM)" }
);

const radar = L.tileLayer(
  "https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/nexrad-n0q-900913/{z}/{x}/{y}.png",
  { maxZoom: 12, opacity: 0.55, attribution: "NEXRAD (IEM)" }
);

const markers = L.layerGroup().addTo(map);

// UI wiring
const cloudToggle = document.getElementById("cloudToggle");
const radarToggle = document.getElementById("radarToggle");
const flightRulesToggle = document.getElementById("flightRulesToggle");
const overlayOpacity = document.getElementById("overlayOpacity");
const overlayPct = document.getElementById("overlayPct");
const refreshBtn = document.getElementById("refreshBtn");
const meta = document.getElementById("meta");
const frKey = document.getElementById("frKey");

function applyOpacity(){
  const v = Math.max(0, Math.min(100, Number(overlayOpacity.value)));
  overlayPct.textContent = v + "%";
  const op = v / 100;
  clouds.setOpacity(op);
  radar.setOpacity(op);
}

cloudToggle.addEventListener("change", () => {
  if (cloudToggle.checked) clouds.addTo(map);
  else map.removeLayer(clouds);
});

radarToggle.addEventListener("change", () => {
  if (radarToggle.checked) radar.addTo(map);
  else map.removeLayer(radar);
});

overlayOpacity.addEventListener("input", applyOpacity);
applyOpacity();

function syncFlightRulesKey(){
  frKey.style.display = flightRulesToggle.checked ? "flex" : "none";
}

// -----------------------------
// Data load + render
// -----------------------------
async function load(){
  const r = await fetch("status.json?ts=" + Date.now());
  if (!r.ok) throw new Error("Failed to load status.json: HTTP " + r.status);
  const d = await r.json();

  meta.textContent = `Last update: ${d.generated_utc} UTC`;

  const regions = d.regions || {};
  const airports = d.airports || {};

  updateOverallBar(airports);

  // Map markers
  markers.clearLayers();

  const showFRColors = !!flightRulesToggle.checked;

  // Build region tables
  let html = "";

  for (const regionName of Object.keys(regions)) {
    let rows = "";

    for (const a of (regions[regionName] || [])) {
      const st = airports[a.code] || {};

      // Marker color: status normally, flight rules when toggle is ON
      const col = showFRColors ? flightRuleColor(st.flight_category) : markerColor(st.status);

      L.circleMarker([a.lat, a.lon], {
        radius: 8,
        weight: 3,
        color: "#000",
        fillColor: col,
        fillOpacity: 0.95
      })
      .bindPopup(
        `<b>${esc(a.code)}</b><br>${esc(a.name)}<br>` +
        `Status: ${esc(st.status || "OK")}<br>` +
        `Flight: ${esc(st.flight_category || "UNK")}`
      )
      .addTo(markers);

      // Table rows
      rows += `
        <tr>
          <td><b>${esc(a.code)}</b><br><span class="small muted">${esc(a.name)}</span></td>
          <td>${statusPill(st.status || "OK")}</td>
          <td>${flightPill(st.flight_category || "UNK")}</td>
        </tr>
      `;
    }

    html += `
      <div class="card">
        <h2>${esc(regionName)}</h2>
        <table>
          <tr><th>Airport</th><th>Status</th><th>Flight Rules</th></tr>
          ${rows}
        </table>
      </div>
    `;
  }

  document.getElementById("grid").innerHTML = html;

  // Show/hide key after render
  syncFlightRulesKey();
}

async function refresh(){
  try {
    await load();
  } catch (e) {
    meta.textContent = "Error: " + (e && e.message ? e.message : "Unknown error");
  }
}

refreshBtn.addEventListener("click", refresh);

// Toggle: show/hide key + repaint markers via refresh
flightRulesToggle.addEventListener("change", refresh);

refresh();
setInterval(refresh, REFRESH_MS);
</script>

</body>
</html>
