<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PA Airport Status</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; color:#111; }
header { display:flex; flex-wrap:wrap; align-items:baseline; gap: 10px; margin-bottom: 10px; }
h1 { font-size: 1.25rem; margin: 0; }
.meta { font-size: 0.9rem; color:#333; }
.btn { padding: 6px 10px; border-radius: 10px; border:1px solid #333; background:#fff; cursor:pointer; }

#map { height: 360px; border: 1px solid #333; border-radius: 12px; }

.toggle { display:flex; align-items:center; gap:10px; border:1px solid #333; border-radius: 12px; padding: 6px 10px; background:#fff; }
.toggles { display:flex; gap:12px; flex-wrap:wrap; margin-top:8px; }

.switch { position: relative; display: inline-block; width: 44px; height: 24px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background:#ddd; border:1px solid #333; transition:.15s; border-radius:999px; }
.slider:before { position:absolute; content:""; height:18px; width:18px; left:3px; top:2px; background:#fff; border:1px solid #333; transition:.15s; border-radius:999px; }
.switch input:checked + .slider { background:#d4edda; }
.switch input:checked + .slider:before { transform: translateX(19px); }

.opacityCtl { display:flex; gap:12px; margin-top:8px; flex-wrap:wrap; }
.opacityGroup { display:none; align-items:center; gap:10px; border:1px solid #333; border-radius: 12px; padding: 6px 10px; background:#fff; }

.grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(440px, 1fr)); gap: 12px; margin-top: 12px; }
.card { border:1px solid #333; border-radius: 12px; padding: 10px; }

.pill { display:inline-block; padding: 2px 10px; border-radius:999px; border:1px solid #333; font-weight:900; cursor:pointer; }
.pill-vfr { background:#d4edda; }
.pill-mvfr { background:#fff3cd; }
.pill-ifr { background:#f8d7da; }
.pill-lifr { background:#e6d6ff; }
.pill-unk { background:#eee; }

#metarOverlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.35);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 18px;
  z-index: 5000;
}
#metarModal {
  width: min(860px, 100%);
  background: #fff;
  border: 2px solid #111;
  border-radius: 14px;
  padding: 12px;
}
pre { border:1px solid #333; border-radius:12px; padding:10px; background:#fafafa; white-space:pre-wrap; }
</style>
</head>

<body>

<header>
  <h1>PA Airport Status</h1>
  <button class="btn" id="refreshBtn">Refresh</button>
  <div class="meta" id="meta">Loading…</div>
</header>

<div id="map"></div>

<div class="toggles">
  <div class="toggle">Cloud
    <label class="switch"><input type="checkbox" id="cloudToggle"><span class="slider"></span></label>
  </div>
  <div class="toggle">Radar
    <label class="switch"><input type="checkbox" id="radarToggle"><span class="slider"></span></label>
  </div>
</div>

<div class="opacityCtl">
  <div class="opacityGroup" id="cloudOpacityGroup">
    Cloud opacity
    <input id="cloudOpacity" type="range" min="0" max="100" value="55">
    <span id="cloudPct">55%</span>
  </div>
  <div class="opacityGroup" id="radarOpacityGroup">
    Radar opacity
    <input id="radarOpacity" type="range" min="0" max="100" value="55">
    <span id="radarPct">55%</span>
  </div>
</div>

<div class="grid" id="grid"></div>

<div id="metarOverlay">
  <div id="metarModal">
    <div style="display:flex;justify-content:space-between;">
      <div id="metarTitle"></div>
      <button onclick="closeMetar()">Close</button>
    </div>
    <pre id="metarBody">Loading…</pre>
    <div id="metarHint"></div>
  </div>
</div>

<script>
const map = L.map("map").setView([40.9, -77.7], 7);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

const clouds = L.tileLayer("https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/sat/{z}/{x}/{y}.png",{opacity:0.55});
const radar  = L.tileLayer("https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/nexrad-n0q-900913/{z}/{x}/{y}.png",{opacity:0.55});
const markers = L.layerGroup().addTo(map);

const cloudToggle = document.getElementById("cloudToggle");
const radarToggle = document.getElementById("radarToggle");
const cloudOpacityGroup = document.getElementById("cloudOpacityGroup");
const radarOpacityGroup = document.getElementById("radarOpacityGroup");

cloudToggle.addEventListener("change", ()=>{
  cloudOpacityGroup.style.display = cloudToggle.checked ? "flex":"none";
  cloudToggle.checked ? clouds.addTo(map) : map.removeLayer(clouds);
});
radarToggle.addEventListener("change", ()=>{
  radarOpacityGroup.style.display = radarToggle.checked ? "flex":"none";
  radarToggle.checked ? radar.addTo(map) : map.removeLayer(radar);
});

document.getElementById("cloudOpacity").addEventListener("input",e=>{
  clouds.setOpacity(e.target.value/100);
  document.getElementById("cloudPct").textContent = e.target.value+"%";
});
document.getElementById("radarOpacity").addEventListener("input",e=>{
  radar.setOpacity(e.target.value/100);
  document.getElementById("radarPct").textContent = e.target.value+"%";
});

let LAST_AIRPORTS = {};
let LAST_NAMES = {};

function flightPill(cat, code){
  return `<span class="pill pill-${cat.toLowerCase()} metar-pill" data-code="${code}">${cat}</span>`;
}

async function fetchMetarViaProxy(station){
  const r = await fetch(`metar.php?station=${station}`, { cache:"no-store" });
  const text = await r.text();
  if (!r.ok) throw new Error("HTTP "+r.status);

  const trimmed = text.trim();
  if (!trimmed) throw new Error("Empty response");

  if (trimmed.startsWith("{")) {
    const j = JSON.parse(trimmed);
    if (!j.ok || !j.metar) throw new Error(j.error || "Bad JSON");
    return j.metar;
  }

  return trimmed;
}

function closeMetar(){ document.getElementById("metarOverlay").style.display="none"; }

async function openMetar(code){
  document.getElementById("metarOverlay").style.display="flex";
  document.getElementById("metarTitle").textContent = "METAR - "+code;
  document.getElementById("metarBody").textContent = "Loading…";

  const station = code.length===3 ? "K"+code : code;

  try{
    const m = await fetchMetarViaProxy(station);
    document.getElementById("metarBody").textContent = m;
  }catch(e){
    document.getElementById("metarBody").textContent =
      `Could not load METAR for ${station}\n\nReason: ${e.message}\n\nTry opening:\nmetar.php?station=${station}`;
  }
}

document.getElementById("grid").addEventListener("click",e=>{
  const p = e.target.closest(".metar-pill");
  if(p) openMetar(p.dataset.code);
});

async function load(){
  const r = await fetch("status.json?ts="+Date.now());
  const d = await r.json();
  const regions = d.regions || {};
  const airports = d.airports || {};
  LAST_AIRPORTS = airports;

  markers.clearLayers();
  let html="";

  for(const region of Object.keys(regions)){
    let rows="";
    for(const a of regions[region]){
      const st = airports[a.code]||{};
      const cat = (st.flight_category||"UNK").toUpperCase();

      L.circleMarker([a.lat,a.lon],{
        radius:8,weight:3,color:"#000",fillOpacity:0.95,
        fillColor: cat==="VFR"?"#2ecc71":cat==="MVFR"?"#f1c40f":cat==="IFR"?"#e74c3c":cat==="LIFR"?"#9b59b6":"#aaa"
      }).addTo(markers);

      rows += `<tr><td><b>${a.code}</b><br>${a.name}</td><td>${flightPill(cat,a.code)}</td></tr>`;
    }

    html += `<div class="card"><h3>${region}</h3><table>${rows}</table></div>`;
  }

  document.getElementById("grid").innerHTML = html;
}

load();
setInterval(load, 300000);
</script>
</body>
</html>
