<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PA Airport Status</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; color:#111; }
    header { display:flex; flex-wrap:wrap; align-items:baseline; gap: 10px; margin-bottom: 10px; }
    h1 { font-size: 1.25rem; margin: 0; }
    .meta { font-size: 0.9rem; color:#333; }
    .btn { padding: 6px 10px; border-radius: 10px; border:1px solid #333; background:#fff; cursor:pointer; }

    /* OVERALL STATUS BAR */
    .overall {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin: 10px 0 10px 0;
      padding: 10px 12px;
      border: 1px solid #333;
      border-radius: 12px;
      flex-wrap: wrap;
    }
    .overall-left { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .overall-dot { width: 12px; height: 12px; border-radius: 999px; border:1px solid #333; display:inline-block; }
    .overall-title { font-weight: 900; }
    .overall-text { font-weight: 900; }
    .overall-counts { font-size: 0.95rem; color:#222; font-variant-numeric: tabular-nums; }
    .overall-ok { background:#d4edda; }
    .overall-impact { background:#fff3cd; }
    .overall-closed { background:#f8d7da; }
    .dot-ok { background:#2ecc71; }
    .dot-impact { background:#f1c40f; }
    .dot-closed { background:#e74c3c; }

    #map { height: 360px; border: 1px solid #333; border-radius: 12px; overflow:hidden; background:#fafafa; }

    .legend { display:flex; gap: 12px; align-items:center; margin-top: 8px; font-size: 0.9rem; color:#222; flex-wrap:wrap; }
    .dot { width: 10px; height: 10px; border-radius: 999px; display:inline-block; border:1px solid #333; }
    .dot-ok { background:#2ecc71; }
    .dot-impact { background:#f1c40f; }
    .dot-closed { background:#e74c3c; }

    /* Toggle switches */
    .toggles {
      margin-top: 8px;
      display:flex;
      flex-wrap: wrap;
      gap: 14px 18px;
      align-items: center;
      font-size: 0.95rem;
    }
    .toggle {
      display:flex;
      align-items:center;
      gap:10px;
      border:1px solid #333;
      border-radius: 12px;
      padding: 8px 10px;
      background:#fff;
    }
    .toggle .label { font-weight: 800; }
    .switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
      flex: 0 0 auto;
    }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #ddd;
      border: 1px solid #333;
      transition: .15s;
      border-radius: 999px;
    }
    .slider:before {
      position: absolute; content: "";
      height: 18px; width: 18px;
      left: 3px; top: 2px;
      background: #fff;
      border: 1px solid #333;
      transition: .15s;
      border-radius: 999px;
    }
    .switch input:checked + .slider { background: #d4edda; }
    .switch input:checked + .slider:before { transform: translateX(19px); }

    .opacityCtl {
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 8px;
      font-size: 0.95rem;
    }
    .opacityCtl label { font-weight: 800; }
    #overlayOpacity { width: 240px; }
    #overlayPct { font-variant-numeric: tabular-nums; font-weight: 900; }

    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(440px, 1fr)); gap: 12px; margin-top: 12px; }
    .card { border:1px solid #333; border-radius: 12px; padding: 10px; }
    .card h2 { margin: 0 0 8px 0; font-size: 1.05rem; }

    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; vertical-align: top; padding: 6px; border-top: 1px solid #ddd; }
    th { font-weight: 800; }

    .pill {
      display:inline-block;
      padding: 2px 10px;
      border-radius: 999px;
      border:1px solid #333;
      font-size: 0.85rem;
      font-weight: 900;
      line-height: 1.4;
      white-space: nowrap;
    }

    .pill-vfr { background:#d4edda; }
    .pill-mvfr { background:#fff3cd; }
    .pill-ifr { background:#f8d7da; }
    .pill-lifr { background:#e6d6ff; }
    .pill-unk { background:#eee; }

    .muted { color:#666; }
    .small { font-size: 0.9rem; color:#444; }

    /* Flight rules map label */
    .fr-label {
      font-weight: 900;
      font-size: 0.85rem;
      border: 1px solid #333;
      border-radius: 10px;
      padding: 2px 6px;
      background: rgba(255,255,255,0.95);
      color:#111;
      box-shadow: 0 1px 0 rgba(0,0,0,0.10);
      user-select: none;
      pointer-events: none;
      white-space: nowrap;
      z-index: 300 !important;
    }

    /* Keep dots above labels */
    .leaflet-interactive { z-index: 500 !important; }
  </style>
</head>

<body>
<header>
  <h1>PA Airport Status</h1>
  <button class="btn" id="refreshBtn">Refresh</button>
  <div class="meta" id="meta">Loadingâ€¦</div>
</header>

<div id="overallBar" class="overall overall-ok">
  <div class="overall-left">
    <span id="overallDot" class="overall-dot dot-ok"></span>
    <span class="overall-title">Overall:</span>
    <span id="overallText" class="overall-text">OK</span>
  </div>
  <div id="overallCounts" class="overall-counts"></div>
</div>

<div id="map"></div>

<div class="legend">
  <span><span class="dot dot-closed"></span> CLOSED</span>
  <span><span class="dot dot-impact"></span> IMPACT</span>
  <span><span class="dot dot-ok"></span> OK</span>
</div>

<div class="toggles">
  <div class="toggle">
    <span class="label">Cloud overlay</span>
    <label class="switch"><input type="checkbox" id="cloudToggle"><span class="slider"></span></label>
  </div>

  <div class="toggle">
    <span class="label">Radar overlay</span>
    <label class="switch"><input type="checkbox" id="radarToggle"><span class="slider"></span></label>
  </div>

  <div class="toggle">
    <span class="label">Flight rules on map</span>
    <label class="switch"><input type="checkbox" id="flightRulesToggle"><span class="slider"></span></label>
  </div>
</div>

<div class="opacityCtl">
  <label for="overlayOpacity">Overlay opacity</label>
  <input id="overlayOpacity" type="range" min="0" max="100" value="55" />
  <span id="overlayPct">55%</span>
</div>

<div class="grid" id="grid"></div>

<script>
const REFRESH_MS = 5 * 60 * 1000;

function flightRuleColor(cat){
  const c = (cat || "UNK").toUpperCase();
  if (c === "VFR") return "#2ecc71";
  if (c === "MVFR") return "#f1c40f";
  if (c === "IFR") return "#e74c3c";
  if (c === "LIFR") return "#9b59b6";
  return "#95a5a6";
}

const map = L.map("map").setView([40.9, -77.7], 7);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19
}).addTo(map);

const clouds = L.tileLayer("https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/sat/{z}/{x}/{y}.png",{maxZoom:8,opacity:0.55});
const radar = L.tileLayer("https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/nexrad-n0q-900913/{z}/{x}/{y}.png",{maxZoom:12,opacity:0.55});

const markers = L.layerGroup().addTo(map);

const cloudToggle = document.getElementById("cloudToggle");
const radarToggle = document.getElementById("radarToggle");
const flightRulesToggle = document.getElementById("flightRulesToggle");
const overlayOpacity = document.getElementById("overlayOpacity");
const overlayPct = document.getElementById("overlayPct");
const refreshBtn = document.getElementById("refreshBtn");
const meta = document.getElementById("meta");

function applyOpacity(){
  const v = overlayOpacity.value;
  overlayPct.textContent = v + "%";
  clouds.setOpacity(v/100);
  radar.setOpacity(v/100);
}

cloudToggle.onchange = () => cloudToggle.checked ? clouds.addTo(map) : map.removeLayer(clouds);
radarToggle.onchange = () => radarToggle.checked ? radar.addTo(map) : map.removeLayer(radar);
overlayOpacity.oninput = applyOpacity;
applyOpacity();

async function load(){
  const r = await fetch("status.json?ts="+Date.now());
  const d = await r.json();
  meta.textContent = `Last update: ${d.generated_utc} UTC`;

  const regions = d.regions || {};
  const airports = d.airports || {};
  markers.clearLayers();

  const showFR = flightRulesToggle.checked;

  for(const region of Object.values(regions)){
    for(const a of region){
      const st = airports[a.code] || {};
      const col = showFR ? flightRuleColor(st.flight_category) : flightRuleColor(st.status);

      const m = L.circleMarker([a.lat,a.lon],{
        radius:8,
        weight:3,
        color:"#000",
        fillColor:col,
        fillOpacity:0.95
      }).addTo(markers);

      if(showFR){
        m.bindTooltip((st.flight_category||"UNK").toUpperCase(),{
          permanent:true,
          direction:"right",
          offset:[14,0],
          className:"fr-label"
        });
      }
    }
  }
}

refreshBtn.onclick = load;
flightRulesToggle.onchange = load;

load();
setInterval(load, REFRESH_MS);
</script>

</body>
</html>
