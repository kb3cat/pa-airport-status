<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PA Airport Status (FAA NAS Status)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; color:#111; }
    header { display:flex; flex-wrap:wrap; align-items:baseline; gap: 10px; margin-bottom: 6px; }
    h1 { font-size: 1.25rem; margin: 0; }
    .meta { font-size: 0.9rem; color:#333; }
    .btn { padding: 6px 10px; border-radius: 10px; border:1px solid #333; background:#fff; cursor:pointer; }

    .banner { border: 1px solid #333; border-radius: 12px; padding: 8px 12px; margin: 10px 0 14px 0; font-weight: 800; }
    .banner-ok { background: #d4edda; }
    .banner-impact { background: #fff3cd; }
    .banner-closed { background: #f8d7da; }
    .banner-error { background:#ffe6e6; }

    @keyframes flashBanner {
      0%,100% { filter: brightness(1); }
      50% { filter: brightness(1.25); }
    }
    .banner-flash {
      animation: flashBanner 0.9s linear infinite;
      outline: 3px solid #000;
    }

    #mapWrap { margin: 0 0 14px 0; }
    #map { height: 320px; border: 1px solid #333; border-radius: 12px; background:#fafafa; }
    .mapLegend { display:flex; gap: 12px; align-items:center; margin-top: 6px; font-size: 0.9rem; }
    .dot { width: 10px; height: 10px; border-radius: 999px; display:inline-block; border:1px solid #333; }
    .dot-ok { background:#d4edda; }
    .dot-impact { background:#fff3cd; }
    .dot-closed { background:#f8d7da; }

    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(440px, 1fr)); gap: 12px; }
    .card { border:1px solid #333; border-radius: 12px; padding: 10px; }
    .card h2 { margin: 0 0 8px 0; font-size: 1.05rem; }

    table { width:100%; border-collapse: collapse; }
    th, td { padding: 6px; border-top: 1px solid #ddd; }
    th { font-weight: 800; }

    .pill { padding: 2px 10px; border-radius: 999px; border:1px solid #333; font-size: 0.85rem; font-weight: 900; }
    .pill-ok { background:#d4edda; }
    .pill-impact { background:#fff3cd; }
    .pill-closed { background:#f8d7da; }

    .small { font-size: 0.9rem; color:#444; }
    .muted { color:#666; }
  </style>
</head>

<body>

<header>
  <h1>PA Airport Status (FAA NAS Status)</h1>
  <button class="btn" id="refreshBtn">Refresh</button>
  <div class="meta" id="meta">Loadingâ€¦</div>
</header>

<div class="banner banner-ok" id="banner">Loadingâ€¦</div>

<div id="mapWrap">
  <div id="map"></div>
  <div class="mapLegend">
    <span><span class="dot dot-closed"></span> CLOSED</span>
    <span><span class="dot dot-impact"></span> IMPACT</span>
    <span><span class="dot dot-ok"></span> OK</span>
  </div>
</div>

<div class="grid" id="grid"></div>

<script>
const REFRESH_MS = 5 * 60 * 1000;
const FLASH_MS = 20 * 1000;
const STORAGE_KEY = "paAirportClosedSet";

const banner = document.getElementById("banner");
const meta = document.getElementById("meta");

function computeStatus(st){
  if(st.closed) return "CLOSED";
  if(st.status === "IMPACT") return "IMPACT";
  return "OK";
}

function pill(s){
  if(s==="CLOSED") return '<span class="pill pill-closed">CLOSED</span>';
  if(s==="IMPACT") return '<span class="pill pill-impact">IMPACT</span>';
  return '<span class="pill pill-ok">OK</span>';
}

function humanize(raw){
  if(!raw) return "Airport closed";
  raw = raw.toUpperCase();
  if(raw.includes("SNOW")) return "Snow removal operations";
  if(raw.includes("ICE")) return "Ice conditions";
  return "Operational impact";
}

/* Flash logic */
function getClosedSet(data){
  const arr=[];
  for(const r in data.regions){
    for(const a of data.regions[r]){
      const st=data.airports[a.code];
      if(st && computeStatus(st)==="CLOSED") arr.push(a.code);
    }
  }
  return arr.sort();
}

function startFlash(){
  banner.classList.add("banner-flash");
  clearTimeout(window.__flashTimer);
  window.__flashTimer=setTimeout(()=>banner.classList.remove("banner-flash"),FLASH_MS);
}

/* Map */
let map, layer;

function ensureMap(){
  if(map) return;
  map = L.map("map").setView([40.9,-77.8],7);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18}).addTo(map);
  layer=L.layerGroup().addTo(map);
}

function markerStyle(s){
  if(s==="CLOSED") return {radius:8,fillColor:"#f8d7da",color:"#333",weight:1,fillOpacity:1};
  if(s==="IMPACT") return {radius:7,fillColor:"#fff3cd",color:"#333",weight:1,fillOpacity:1};
  return {radius:6,fillColor:"#d4edda",color:"#333",weight:1,fillOpacity:1};
}

function updateMap(data){
  ensureMap();
  layer.clearLayers();
  for(const r in data.regions){
    for(const a of data.regions[r]){
      const st=data.airports[a.code];
      const s=computeStatus(st);
      L.circleMarker([a.lat,a.lon],markerStyle(s))
       .bindPopup(`<b>${a.code}</b><br>${a.name}<br>${s}`)
       .addTo(layer);
    }
  }
}

async function loadData(){
  const res = await fetch("status.json?ts="+Date.now());
  const data = await res.json();

  meta.textContent = "Updated: "+data.generated_utc+" UTC";

  const prev = JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]");
  const cur = getClosedSet(data);
  if(cur.some(c=>!prev.includes(c))) startFlash();
  localStorage.setItem(STORAGE_KEY,JSON.stringify(cur));

  updateMap(data);

  let html="";
  for(const r in data.regions){
    html+=`<div class="card"><h2>${r}</h2><table>`;
    for(const a of data.regions[r]){
      const st=data.airports[a.code];
      const s=computeStatus(st);
      html+=`<tr>
        <td><b>${a.code}</b></td>
        <td>${a.name}</td>
        <td>${pill(s)}</td>
        <td>${s==="CLOSED"?humanize(st.closure_reason):"â€”"}</td>
      </tr>`;
    }
    html+=`</table></div>`;
  }
  document.getElementById("grid").innerHTML=html;

  if(cur.length){
    banner.className="banner banner-closed";
    banner.innerHTML=`ðŸ”´ <b>${cur.length} airports CLOSED</b>`;
  } else {
    banner.className="banner banner-ok";
    banner.innerHTML="ðŸŸ¢ <b>All PA airports operational</b>";
  }
}

document.getElementById("refreshBtn").onclick=loadData;
loadData();
setInterval(loadData,REFRESH_MS);
</script>
</body>
</html>
